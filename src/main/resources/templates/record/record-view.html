<div th:replace="~{common/head :: head('Record')}"></div>
<body>
<div th:replace="~{common/header :: header('record')}"></div>
<style>
#roastingChart {
    width: 100%;
    height: 500px;
    max-width: 100%;
}
</style>
<main id="main">
    <section id="breadcrumbs" class="breadcrumbs">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h2><a href="/record" class="small-menu">Record</a></h2>
                <ol>
                    <li><a href="/" class="small-menu">Home</a></li>
                    <li><a href="/record" class="small-menu">Record</a></li>
                </ol>
            </div>
        </div>
    </section>

    <section id="notice" class="notice">
        <div class="container" data-aos="fade-up">
            <div class="row">
                <div class="entries">
                    <article class="entry entry-single">

                        <h2 class="entry-view-title">
                            <p>[(${record.title})]</p>
                        </h2>
                        <div class="entry-meta">
                            <ul>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-clock"></i>[(${#temporals.format(record.createdDt, 'yyyy-MM-dd
                                    HH:mm')})]
                                </li>
                            </ul>
                        </div>

                        <div class="entry-content">
                            <div id="roastingChart"></div>
                        </div>

                        <div class="entry-footer">
                            <i class="bi bi-folder"></i>
                            <ul class="cats">
                                <li><a href="/record">Record</a></li>
                            </ul>
                        </div>

                        <div class="entry-button">
                            <div>
                                <button th:onclick="|location.href='@{/record}'|" class="btn btn-outline-dark">목록
                                </button>
                            </div>
                        </div>

                    </article>
                </div>
            </div>
        </div>
    </section>

    <div th:replace="~{common/footer :: footer}"></div>
</main>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<div th:replace="~{common/commonjs}"></div>
<script th:src="@{/js/library/amcharts/index.js}"></script>
<script th:src="@{/js/library/amcharts/xy.js}"></script>
<script th:src="@{/js/library/amcharts/themes/Animated.js}"></script>
<script type="text/javascript" th:inline="javascript">
    am5.ready(function() {

        // Create root element
        let root = am5.Root.new("roastingChart");
        const myTheme = am5.Theme.new(root);

        myTheme.rule("AxisLabel", ["minor"]).setAll({
            dy:1
        });

        myTheme.rule("Grid", ["x"]).setAll({
            strokeOpacity: 0.05
        });

        myTheme.rule("Grid", ["x", "minor"]).setAll({
            strokeOpacity: 0.05
        });

        // Set themes
        root.setThemes([
            am5themes_Animated.new(root),
            myTheme
        ]);

        // Create chart
        let chart = root.container.children.push(
            am5xy.XYChart.new(root, {
                panX: true,
                panY: true,
                wheelX: "panX",
                wheelY: "zoomX",
                layout: root.verticalLayout,
                pinchZoomX:true
            })
        );

        chart.get("colors").set("colors", [
            am5.color("#FF0000"),
            am5.color("#0000FF"),
            am5.color("#FFFF00"),
            am5.color("#008000")
        ]);

        // Add cursor
        let cursor = chart.set("cursor", am5xy.XYCursor.new(root, {
            behavior: "none"
        }));
        cursor.lineY.set("visible", false);

        let dataSize = 0;
        if ([[${record.temp1}]] !== null) {
            dataSize = JSON.parse([[${record.temp1}]]).length;
        }

        let temp1Arr = generateGraphData([[${record.temp1}]], dataSize);
        let temp2Arr = generateGraphData([[${record.temp2}]], dataSize);
        let temp3Arr = generateGraphData([[${record.temp3}]], dataSize);
        let rorArr = generateGraphData([[${record.ror}]], dataSize);

        let data = [];
        for (let i = 0; i < dataSize; i++) {
            let min = parseInt((i + 1) / 60);
            let sec = (min > 0 ? parseInt((i + 1) / 60) : "") + "′" + (i + 1) % 60;
            data.push(
                {
                    second: sec,
                    temp1: temp1Arr[i],
                    temp2: temp2Arr[i],
                    temp3: temp3Arr[i],
                    ror: rorArr[i]
                }
            );
        }

        // Create axes
        let xAxis = chart.xAxes.push(
            am5xy.CategoryAxis.new(root, {
                categoryField: "second",
                renderer: am5xy.AxisRendererX.new(root, {}),
                tooltip: am5.Tooltip.new(root, {})
            })
        );

        xAxis.data.setAll(data);

        let yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
                maxPrecision: 0,
                renderer: am5xy.AxisRendererY.new(root, {})
            })
        );

        function createSeries(name, field) {
            let series = chart.series.push(
                am5xy.LineSeries.new(root, {
                    name: name,
                    xAxis: xAxis,
                    yAxis: yAxis,
                    valueYField: field,
                    categoryXField: "second",
                    legendValueText: "{valueY}",
                    tooltip: am5.Tooltip.new(root, {
                        pointerOrientation: "horizontal",
                        labelText: "[bold]{name}: {valueY}"
                    })
                })
            );

            series.data.setAll(data);
            series.appear(1000);
        }

        createSeries("Temp1", "temp1");
        createSeries("Temp2", "temp2");
        createSeries("Temp3", "temp3");
        createSeries("ROR", "ror");

        // Add scrollbar
        chart.set("scrollbarX", am5.Scrollbar.new(root, {
            orientation: "horizontal"
        }));

        chart.set("scrollbarY", am5.Scrollbar.new(root, {
            orientation: "vertical"
        }));

        // Add legend
        let legend = chart.rightAxesContainer.children.push(am5.Legend.new(root, {
            width: 200,
            paddingLeft: 15,
            height: am5.percent(100)
        }));

        // When legend item container is hovered, dim all the series except the hovered one
        legend.itemContainers.template.events.on("pointerover", function(e) {
            let itemContainer = e.target;

            // As series list is data of a legend, dataContext is series
            let series = itemContainer.dataItem.dataContext;

            chart.series.each(function(chartSeries) {
                if (chartSeries != series) {
                    chartSeries.strokes.template.setAll({
                        strokeOpacity: 0.15,
                        stroke: am5.color(0x000000)
                    });
                } else {
                    chartSeries.strokes.template.setAll({
                        strokeWidth: 3
                    });
                }
            })
        })

        // When legend item container is unhovered, make all series as they are
        legend.itemContainers.template.events.on("pointerout", function(e) {
            let itemContainer = e.target;
            let series = itemContainer.dataItem.dataContext;

            chart.series.each(function(chartSeries) {
                chartSeries.strokes.template.setAll({
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    stroke: chartSeries.get("fill")
                });
            });
        })

        legend.itemContainers.template.set("width", am5.p100);
        legend.valueLabels.template.setAll({
            width: am5.p100,
            textAlign: "right"
        });

        // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
        legend.data.setAll(chart.series.values);

        // Make stuff animate on load
        chart.appear(1000, 100);
    });

    function generateGraphData(data, size) {
        if (data === null) {
            return Array(size).fill(0);
        }

        return JSON.parse(data);
    }
</script>
</body>
</html>